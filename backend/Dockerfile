# Python 3.11 ê¸°ë°˜ ì´ë¯¸ì§€
FROM python:3.11-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    wget \
    gnupg \
    ca-certificates \
    fonts-liberation \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libwayland-client0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxkbcommon0 \
    libxrandr2 \
    xdg-utils \
    libu2f-udev \
    libvulkan1 \
    && rm -rf /var/lib/apt/lists/*

# Google Chrome ì„¤ì¹˜ (Seleniumìš©)
RUN wget -q -O /tmp/google-chrome-stable_current_amd64.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb \
    && apt-get update \
    && apt-get install -y /tmp/google-chrome-stable_current_amd64.deb \
    && rm /tmp/google-chrome-stable_current_amd64.deb \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± íŒŒì¼ ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜ (Chromiumë§Œ)
RUN playwright install --with-deps chromium

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8000

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ê¸°ë³¸ê°’)
ENV PORT=8000
ENV HOST=0.0.0.0

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD python -c "import requests; requests.get('http://localhost:8000/api/health')" || exit 1

# ì„œë²„ ì‹œì‘
# ğŸ›¡ï¸ Uvicorn ìµœì í™” ì„¤ì • (100+ ë™ì‹œ ìœ ì € ëŒ€ì‘)
# --workers 1: APSchedulerì™€ ì¸ë©”ëª¨ë¦¬ ë ˆì´íŠ¸ ë¦¬ë°‹ì˜ ì •í•©ì„±ì„ ìœ„í•´ ë‹¨ì¼ ì›Œì»¤ ìœ ì§€
#              (async FastAPIëŠ” ë‹¨ì¼ ì›Œì»¤ë¡œë„ ìˆ˜ë°± ê°œ ë™ì‹œ I/O ìš”ì²­ ì²˜ë¦¬ ê°€ëŠ¥)
# --limit-concurrency 200: ìµœëŒ€ ë™ì‹œ ì ‘ì† 200ê°œ (100ëª… Ã— ìœ ì €ë‹¹ 2ê°œ ì»¤ë„¥ì…˜)
# --timeout-keep-alive 30: Keep-alive 30ì´ˆ (ê¸°ë³¸ 5ì´ˆ â†’ ì—°ê²° ì¬ì‚¬ìš© íš¨ìœ¨ í–¥ìƒ)
# --backlog 200: TCP ë°±ë¡œê·¸ 200 (ëŒ€ê¸° í í¬ê¸°)
CMD ["sh", "-c", "uvicorn app.main:app --host ${HOST} --port ${PORT} --workers 1 --limit-concurrency 200 --timeout-keep-alive 30 --backlog 200"]
